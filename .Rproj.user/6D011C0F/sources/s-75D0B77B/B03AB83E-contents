library(shiny)
library(shinydashboard)
library(shinyWidgets)
library(tidyverse)
library(shinyalert)
library(leaflet)
library(leaflet.extras)
library(BEEF2021functions)
library(tidyverse)
library(DT)
# remotes::install_github("anitazoechang/BEEF2021functions@main")

##### Shiny server #####
Shinyserver <- function(input, output, session) {
  schools <<- get_school()
  leaderboard <- schools[order(schools$weight, decreasing = TRUE),]
  leaderboard$rank <- seq(1:nrow(leaderboard))
  leaderboard <- leaderboard %>%
    select(rank, school, class, weight)
  leaderboard$weight <- paste0(leaderboard$weight, "kg")
  colnames(leaderboard) <- c("Rank", "School", "Class", "Weight")
  leaderboard <<- leaderboard
  
  # Leaderboard
  output$leaderboardtext <- renderDataTable(datatable(tibble(
    Rank = leaderboard$Rank,
    School = leaderboard$School,
    Class = leaderboard$Class,
    Weight = leaderboard$Weight),
    rownames = FALSE))
  
  # Sidebar
  output$sidebar <- renderUI({
    div(width = 500, height = 1, shinyjs::useShinyjs(), id="side-panel",
        fluidRow(align = "center", tags$a(tags$img(src = "logo.png", height = 120, width = 170))),
        fluidRow(h4("BEEF2021 Weight Challenge Leaderboard", color = "#6e6d71"), align = "center"),
        dataTableOutput("leaderboardtext"),
        fluidRow(column(width = 6, actionButton("addschool", label = "Add school", style = "color: #6d6e71")))
    )
  })
  
  output$map <- renderLeaflet({
    leaflet(schools) %>%
      addProviderTiles(providers$OpenStreetMap) %>%
      setView(lng = 147.842393, lat = -24.000942, zoom = 6) %>% 
      addSearchOSM(options = searchOptions(collapsed = TRUE)) %>%
      addCircleMarkers(radius = 6, stroke = FALSE, fillOpacity = 0.7,
                       fillColor = "#4C9364",
                       popup = paste(paste(schools$school), 
                                     paste(schools$class),
                                     paste0(schools$weight, "kg"),
                                     sep = "</br>"))
  })
  
  addschoolmodal <<- modalDialog(
    title = "Add new school",
    fluidRow(column(width = 3, "School name:"),
             column(width = 7, textInput(inputId = "school", label = NULL, value = NULL))),
    fluidRow(column(width = 3, "Class name:"),
             column(width = 7, textInput(inputId = "class", label = NULL, value = NULL))),
    fluidRow(column(width = 3, "Weight:"),
             column(width = 7, numericInput(inputId = "weight", label = NULL, value = NULL))),
    # fluidRow(column(width = 3, "Latitude:"),
    #          column(width = 7, numericInput(inputId = "lat", label = NULL, value = NULL))),
    # fluidRow(column(width = 3, "Longitude:"),
    #          column(width = 7, numericInput(inputId = "long", label = NULL, value = NULL))),
    footer = fluidRow(column(width = 3),
                      column(width = 2, actionButton("addschooltodb", "Add school", style = "color: #6d6e71")),
                      column(width = 2),
                      column(width = 2, actionButton("cancel", "Close", style = "color: #6d6e71"))), 
    easyClose = TRUE
  )
  
  ##### Buttons ######
  # Add school modal
  observeEvent(input$addschool, {
    if(input$addschool == 1){
      showModal(addschoolmodal)
    }
  })
  
  # Cancel
  observeEvent(c(input$cancel), {
    removeModal() 
  })
  
  
  # Add schools
  observeEvent(c(input$addschooltodb, input$school, input$class, 
                 input$weight, input$lat, input$long, input$MAPID_center), {
                   if(input$addschooltodb == 1){
                     if(length(input$class > 0)){
                       add_school(school = input$school, class = input$class,
                                  lat = input$MAPID_center$lat, long = input$MAPID_center$lng, weight = input$weight)
                     } else {
                       add_school(school = input$school,
                                  lat = input$lat, long = input$long, weight = input$weight)}
                     removeModal()
                     session$reload()
                   }
                 })
  
}